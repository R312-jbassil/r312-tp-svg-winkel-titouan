---
import "../styles/global.css";
import { ui } from "../i18n/ui.js";

// Récupère la langue depuis le cookie
function getCookie(name) {
	const match = document.cookie.match(
		new RegExp("(^| )" + name + "=([^;]+)"),
	);
	return match ? match[2] : null;
}

// Fallback sur Astro.locals.lang si le cookie n'existe pas
const locale =
	typeof document === "undefined"
		? Astro.locals.lang || "en"
		: getCookie("lang") || Astro.locals.lang || "en";

const user = Astro.locals.user;
---

<!doctype html>
<html lang={locale} data-theme="light" class="h-full">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<title>Astro Basics</title>

		<link
			href="https://cdn.jsdelivr.net/npm/daisyui@3.8.0/dist/full.css"
			rel="stylesheet"
			type="text/css"
		/>
		<script src="https://cdn.tailwindcss.com"></script>
	</head>

	<body class="h-full">
		<div class="h-full flex flex-col min-h-0">
			<nav
				class="flex items-center justify-between bg-base-200 p-4 shadow-md"
			>
				<!-- Sélecteur de langue côté client -->
				<select class="select select-bordered" id="lang-select">
					<option value="en" selected={locale === "en"}
						>English</option
					>
					<option value="fr" selected={locale === "fr"}
						>Français</option
					>
				</select>

				<!-- Authentification -->
				<div class="flex items-center gap-3">
					{
						user ? (
							<>
								<span class="text-sm text-gray-700">
									Bonjour, {user.name || user.email}
								</span>
								<form
									method="POST"
									action="/api/logout"
									class="m-0 p-0"
								>
									<button
										type="submit"
										class="btn btn-primary btn-sm"
									>
										Logout
									</button>
								</form>
							</>
						) : (
							<>
								<a href="/login" class="btn btn-outline btn-sm">
									Connexion
								</a>
								<a
									href="/signup"
									class="btn btn-primary btn-sm"
								>
									Inscription
								</a>
							</>
						)
					}
				</div>
			</nav>

			<div class="flex-1 min-h-0">
				<slot />
			</div>
		</div>

		<script>
			const select = document.getElementById("lang-select");
			select.addEventListener("change", (e) => {
				const lang = e.target.value;
				document.cookie = `lang=${lang}; path=/; max-age=${60 * 60 * 24 * 365}; SameSite=Lax`;
				window.location.reload();
			});
		</script>
	</body>
</html>
